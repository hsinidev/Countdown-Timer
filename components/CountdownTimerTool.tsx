import React, { useState, useCallback, useEffect } from 'react';
import { useTimer, formatTime } from '../utils/TimerLogic';

const CountdownTimerTool: React.FC = () => {
  const [hoursInput, setHoursInput] = useState('0');
  const [minutesInput, setMinutesInput] = useState('25');
  const [secondsInput, setSecondsInput] = useState('0');
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  const handleTimerEnd = useCallback(() => {
    if (soundEnabled) {
      try {
        // A clean, short, and reliable audio file to prevent loading errors.
        const audio = new Audio("data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU2LjQxAAAAAAAAAAAAAAAAAAAAAAAACQAAAAAAAAAASUREBAAANgAATEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//MUwA0AACx0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8xPANQAK559f///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAA//MUwAsAFwB9f/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAAP/zFMAQABkAHX1//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwBEAGgAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAYAEgAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAcAFgAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAgAHQAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAkAIIAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAoAJIAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAsAKoAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwAwAMEAdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwA4AN4AdX/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA//MUwBAAPPAeX//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAA");
        audio.play();
      } catch (error) {
        console.error("Failed to play sound:", error);
      }
    }
  }, [soundEnabled]);
  
  const calculateTotalSeconds = useCallback(() => {
    const hrs = parseInt(hoursInput, 10) || 0;
    const mins = parseInt(minutesInput, 10) || 0;
    const secs = parseInt(secondsInput, 10) || 0;
    return Math.max(0, (hrs * 3600) + (mins * 60) + secs);
  }, [hoursInput, minutesInput, secondsInput]);

  const { remainingSeconds, isRunning, start, pause, reset, setTime } = useTimer(
    calculateTotalSeconds(),
    handleTimerEnd
  );

  const isTimerZero = remainingSeconds === 0 && !isRunning;

  useEffect(() => {
    const { hours, minutes, seconds } = formatTime(remainingSeconds);
    document.title = `${hours}:${minutes}:${seconds} - Cosmic Timer`;
  }, [remainingSeconds]);

  const handleSetTime = useCallback(() => {
    setTime(calculateTotalSeconds());
  }, [setTime, calculateTotalSeconds]);
  
  const handlePreset = (mins: number) => {
      setHoursInput('0');
      setMinutesInput(String(mins));
      setSecondsInput('0');
      setTime(mins * 60);
  }
  
  const handleStart = () => {
    if (isTimerZero) {
        handleSetTime();
    }
    // Use a timeout to ensure the state has been updated before starting
    setTimeout(() => start(), 50);
  };
  
  const handleReset = () => {
      reset(calculateTotalSeconds());
  }

  const { hours, minutes, seconds } = formatTime(remainingSeconds);
  const displayClasses = isRunning ? "opacity-100" : "opacity-70";
  const inputClasses = isRunning ? "opacity-0 pointer-events-none" : "opacity-100";
  
  return (
     <div className="flex flex-col items-center justify-center w-full max-w-4xl mx-auto p-4 text-center">
      <div className={`font-mono transition-opacity duration-500 ${displayClasses}`} style={{ fontSize: 'clamp(2.5rem, 18vw, 10rem)', lineHeight: 1, textShadow: '0 0 20px rgba(255,255,255,0.2)'}}>
        <span>{hours}</span>
        <span className="animate-[pulse_2s_ease-in-out_infinite]">:</span>
        <span>{minutes}</span>
        <span className="animate-[pulse_2s_ease-in-out_infinite]">:</span>
        <span>{seconds}</span>
      </div>

      <div className={`transition-opacity duration-500 mt-8 ${inputClasses}`}>
        <div className="flex items-center justify-center space-x-2 md:space-x-4">
            <div className="flex flex-col items-center">
                <input type="number" value={hoursInput} onChange={(e) => setHoursInput(e.target.value)} className="w-20 md:w-28 bg-gray-900 bg-opacity-50 text-white text-3xl md:text-5xl text-center rounded-lg p-2 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500" min="0" />
                <label className="text-xs text-gray-400 mt-1">HOURS</label>
            </div>
             <span className="text-3xl md:text-5xl text-gray-400 pb-4">:</span>
            <div className="flex flex-col items-center">
                <input type="number" value={minutesInput} onChange={(e) => setMinutesInput(e.target.value)} className="w-20 md:w-28 bg-gray-900 bg-opacity-50 text-white text-3xl md:text-5xl text-center rounded-lg p-2 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500" max="59" min="0" />
                 <label className="text-xs text-gray-400 mt-1">MINUTES</label>
            </div>
             <span className="text-3xl md:text-5xl text-gray-400 pb-4">:</span>
            <div className="flex flex-col items-center">
                <input type="number" value={secondsInput} onChange={(e) => setSecondsInput(e.target.value)} className="w-20 md:w-28 bg-gray-900 bg-opacity-50 text-white text-3xl md:text-5xl text-center rounded-lg p-2 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500" max="59" min="0" />
                 <label className="text-xs text-gray-400 mt-1">SECONDS</label>
            </div>
        </div>
         <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-6">
           <button onClick={() => handlePreset(5)} className="bg-gray-800 bg-opacity-50 hover:bg-opacity-75 p-2 rounded-md transition-all">5 min</button>
           <button onClick={() => handlePreset(15)} className="bg-gray-800 bg-opacity-50 hover:bg-opacity-75 p-2 rounded-md transition-all">15 min</button>
           <button onClick={() => handlePreset(25)} className="bg-gray-800 bg-opacity-50 hover:bg-opacity-75 p-2 rounded-md transition-all">25 min</button>
           <button onClick={() => handlePreset(45)} className="bg-gray-800 bg-opacity-50 hover:bg-opacity-75 p-2 rounded-md transition-all">45 min</button>
        </div>
      </div>

      <div className="flex justify-center items-center space-x-4 mt-8">
        {isRunning ? (
          <button onClick={pause} className="text-xl bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-lg">Pause</button>
        ) : (
          <button onClick={handleStart} className="text-xl bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white font-semibold py-3 px-10 rounded-lg transition-transform transform hover:scale-105 shadow-lg">Start</button>
        )}
        <button onClick={handleReset} className="text-xl bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-lg">Reset</button>
        <button onClick={() => setSoundEnabled(!soundEnabled)} className="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition-colors shadow-lg" aria-label="Toggle sound">
          {soundEnabled ? (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 15.858a5 5 0 01-2.828-7.072m11.314 0a1 1 0 011.414 0l.001.001a1 1 0 010 1.414l-8.485 8.485a1 1 0 01-1.414 0l-.001-.001a1 1 0 010-1.414l8.485-8.485zM12 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          ) : (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15.142A5.001 5.001 0 014 12a5 5 0 015-5 5 5 0 015 5 5 5 0 01-1.586 3.142m-4.243 4.242A9 9 0 013 12a9 9 0 019-9 9 9 0 019 9 9 9 0 01-3 6.364m-12 .001l12-12" /></svg>
          )}
        </button>
      </div>
    </div>
  );
};

export default CountdownTimerTool;